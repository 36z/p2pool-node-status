<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="shortcut icon" href="../../docs-assets/ico/favicon.png">

    <title>p2pool node stats</title>

    <!-- Bootstrap core CSS -->
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/bootstrap-theme.min.css">
    <link rel="stylesheet" href="css/font-awesome.min.css">

    <script src="js/jquery-2.0.3.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/jquery-dateFormat.min.js"></script>

    <script src="js/highcharts.js"></script>
    <script src="js/exporting.js"></script>

    <script src="js/util.js"></script>
    <script src="js/charts.js"></script>

    <!-- Custom styles for this template -->
    <link href="grid.css" rel="stylesheet">

    <!-- Just for debugging purposes. Don't actually copy this line! -->
    <!--[if lt IE 9]><script src="../../docs-assets/js/ie8-responsive-file-warning.js"></script><![endif]-->

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->
  </head>

  <body>
    <div class="container">
      <div class="page-header">
        <h1>p2pool node status</h1>
        <b>
          <small>
            Node: <span id='node'></span>&nbsp;&dash;
            Updated: <span id='updated'></span>
          </small>
        </b>
      </div>

      <div id='chart'></div>

      <h4>Status</h4>
      <table id='status' class="table table-hover" border='0'>
        <tr>
          <td>Local rate:</td><td id='local_rate'></td>
          <td>Expected time to share:</td><td id='expected_time_to_share'></td>
        </tr>
        <tr>
          <td>Global pool rate:</td><td id='global_rate'></td>
          <td>Share difficulty</td><td id='share_difficulty'></td>
        </tr>
        <tr>
          <td>Current block value</td><td id='block_value'></td>
          <td>Shares:</td><td id='shares'></td>
        </tr>
        <tr>
          <td>Payout if a block were found NOW</td><td id='payout_now'></td>
          <td>Expected time to block:</td><td id='expected_time_to_block'></td>
        </tr>
        <tr>
          <td>Node peers</td><td id='node_peers'></td>
          <td>Node uptime:</td><td id='node_uptime'></td>
        </tr>
      </table>

      <h4>Active miners on this node</h4>
      <table id='active_miners' class="table table-hover">
        <tr>
          <th class='text-left'>Bitcoin Address</th>
          <th class='text-right'>Hashrate</th>
          <th class='text-right'>DOA Hashrate</th>
          <th class='text-right'>DOA %</th>
          <th class='text-right'>Predicted payout</th>
        </tr>
      </table>

      <h4>Recent blocks</h4>
      <table id='recent_blocks' class="table table-hover">
        <tr>
          <th>Date/Time</th>
          <th>Number</th>
          <th>Hash</th>
          <th>Confirmations</th>
        </tr>
      </table>

    </div> <!-- /container -->
    <script type="text/javascript">

    // define myself ... will be highlighted in results
    var myself= '';

    // the hostname and port of the p2pool node
    var node_host= 'localhost', node_port= '9332';

    // things to remember
    var local_hashrate= 0, local_doa_hashrate= 0;

    var fetchLocalPoolStats= function(url) {
      $.getJSON(url + '?callback=?', {
        t: 'local_stats',
        host: node_host, port: node_port,
      }, function(data) {
        $.each(data.local.miner_hash_rates, function(k, v) {
          // fill the user table
          tr= $('<tr/>').attr('id', k);
          if(myself && k === myself) { tr.addClass('success'); }

          hashrate= v; doa= data.local.miner_dead_hash_rates[k];

          tr.append($('<td/>')
            .append(k));
          tr.append($('<td/>')
            .append(formatHashrate(hashrate)));
          tr.append($('<td/>')
            .append(formatHashrate(doa)));
          tr.append($('<td/>')
            .append(parseFloat((doa/v) * 100).toFixed(2) + '%'));

          if(data.payout) {
            tr.append($('<td/>')
              .append(parseFloat(data.payout).toFixed(8)));
          }
          else {
            tr.append($('<td/>')
              .append($('<i/>').append('no shares yet')));
          }
        });
        setUpdateTime();
      });
    };

    var fetchGlobalPoolStats= function(url) {
      $.getJSON(url + '?callback=?', {
        t: 'global_stats',
        host: node_host, port: node_port,
      }, function(data) {
        setUpdateTime();
      });
    };

    var fetchActiveMiners= function(url) {
      $.getJSON(url + '?callback=?', {
        t: 'active_miners',
        host: node_host, port: node_port,
      }, function(data) {
        local_hashrate= 0, local_doa_hashrate= 0; // reset
        $.each(data, function(k, v) {
          // fill the user table
          tr= $('<tr/>').attr('id', k);
          if(k === myself) { tr.addClass('success'); }

          // hashrate= v; doa= data.local.miner_dead_hash_rates[k];

          // create link to blockchain.info for addresses
          blockinfo= $('<a/>')
            .attr('href', 'https://blockchain.info/address/' + k)
            .attr('target', '_blank').text(k);

          tr.append($('<td/>').attr('class', 'text-left')
            .append(blockinfo));
          tr.append($('<td/>').attr('class', 'text-right')
            .append(formatHashrate(data[k].hashrate)));

          local_hashrate+= data[k].hashrate;

          tr.append($('<td/>').attr('class', 'text-right')
            .append(formatHashrate(data[k].doa_hashrate)));

          local_doa_hashrate+= data[k].doa_hashrate;

          tr.append($('<td/>').attr('class', 'text-right')
            .append((parseFloat(data[k].doa_prop) * 100).toFixed(2) + '%'));

          if(data[k].payout) {
            tr.append($('<td/>').attr('class', 'text-right')
              .append(parseFloat(data[k].payout).toFixed(8)));
          }
          else {
            tr.append($('<td/>').attr('class', 'text-right')
              .append($('<i/>').append('no shares yet')));
          }

          $('#'+k).remove(); $('#active_miners').append(tr);
        });

        // print the local hashrate / dead on arrival hashrate and ratio
        {
          _rate=formatHashrate(local_hashrate);
          _doa= formatHashrate(local_doa_hashrate);
          _prop= (local_doa_hashrate/local_hashrate)*100;
          $('#local_rate')
            .text(_rate + ' (' + _doa + ' / ' + _prop.toFixed(2) + '% DOA)');
        }

        setUpdateTime();
      });
    };

    var fetchRecentBlocks= function(url) {
      $.getJSON(url + '?callback=?', {
        t: 'recent_blocks',
        host: node_host, port: node_port,
      }, function(data) {
        $.each(data, function(k, v) {
          ts= data[k].ts; num= data[k].number; hash= data[k].hash;
          // // link to blockchain.info for the given hash
          blockinfo= $('<a/>')
            .attr('href', 'https://blockchain.info/de/block-index/' + hash)
            .attr('target', '_blank').text(hash);

          tr= $('<tr/>').attr('id', num);
          tr.append($('<td/>')
            .append($.format.prettyDate(new Date(ts * 1000))));
          tr.append($('<td/>').append(num));
          tr.append($('<td/>').append(blockinfo));
          tr.append($('<td/>').html('&dash;'));
          $('#recent_blocks').append(tr);
        });
        setUpdateTime();
      });
    };

    var fetchHashrateGraph= function(url) {
      $.getJSON(url + '?callback=?', {
        t: 'graph_hashrate',
        i: 'day', // get the daily interval for now
        host: node_host, port: node_port,
      }, function(data) {
        console.log(data);
        hashrate= data.hashrate; doa= data.doa_hashrate;
        hashgraph= []; doagraph= [];
        $.each(hashrate, function(key, value) {
          el= []; el.push(value[0] * 1000, value[1]);
          hashgraph.push(el);
        });
        hashgraph.sort();

        $.each(doa, function(key, value) {
          el= []; el.push(value[0] * 1000, value[1]);
          doagraph.push(el);
        });
        doagraph.sort();
        draw(hashgraph, doagraph);
        setUpdateTime();
      })
    };

    var setUpdateTime= function() {
      dts= $.format.date(new Date(), 'yyyy-MM-dd HH:mm:ss');
      $('#updated').text(dts);
    };

    $(document).ready(function() {
      node_link= $('<a/>')
        .attr('href', ('http://' + node_host + ':' + node_port))
        .attr('target', '_blank')
        .text(node_host + ':' + node_port);
      $('#node').append(node_link);

      // the URL to the JSONP PHP script.
      url= 'jsonp.php';

      // re-fetch some data every 10 seconds
      setInterval(function() {
        fetchActiveMiners(url);
      }, 30 * 1000);

      fetchActiveMiners(url);
      fetchRecentBlocks(url);
      fetchHashrateGraph(url);
      $('#updated')
        .text($.format.date(
          new Date(), 'yyyy-MM-dd HH:mm:ss'));
    });
    </script>
  </body>
</html>
